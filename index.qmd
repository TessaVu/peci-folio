---
title: "Philadelphia Demographics"
format: html
---

```{r}
#| echo: false
#| include: false
library(tidyverse)
library(tidycensus)
library(sf)
library(leaflet)
library(leaflet.extras)
library(leaflet.extras2)
library(leafsync)
library(scales)
library(findSVI)
```

```{r}
#| echo: false
#| include: false
# Set Census API key
census_api_key("3aaee31789e10b674a531e9f236c35d5394b19ed")
```

```{r}
#| echo: false
#| include: false
# Selected ACS data from 2023 5-year survey.

acs_data <- read.csv("data/data_overview.csv")

acs_data$GEOID <- as.character(acs_data$GEOID)

acs_data <- acs_data %>%
  mutate(pct_vacancies = housing_vacant / housing_units,
         pct_occupied = housing_occupied / housing_units,
         pct_white = white / pop_total,
         pct_black = black / pop_total,
         pct_hispanic = hispanic / pop_total,
         pct_asian = asian / pop_total,
         pct_native = native / pop_total,
         pct_pacific = pacific / pop_total,
         pct_other = other_race / pop_total,
         pct_two_more = two_more_races / pop_total,
         pct_bach = bach_more / pop_total,
         num_minor = age_under_5 + age_5_to_9_yrs + age_10_to_14_yrs + age_15_to_17_yrs,
         num_adult = age_18_to_24_yrs + age_25_to_34_yrs + age_35_to_44_yrs + age_45_to_54_yrs + age_55_to_64_yrs,
         num_elderly = age_65_to_74_yrs + age_75_to_84_yrs + age_85_over,
         pct_minor = num_minor / pop_total,
         pct_adult = num_adult / pop_total,
         pct_elderly = num_elderly / pop_total,
         pct_homeowner = occupied_housing / pop_total,
         pct_renter = occupied_renter / pop_total,
         pct_undergrad_age = age_18_to_24_yrs / pop_total,
         pct_no_health_insurance = no_health_insurance / pop_total,
         pct_drop_out = age_16_to_19_yrs_drop_out / pop_total,
         pct_female = female / pop_total,
         pct_male = male / pop_total)

acs_data[is.na(acs_data)] <- 0
```

```{r}
#| echo: false
#| include: false
# Shapefile data.

philly_tracts <- st_read("data/philly_tracts/philly_tracts.shp")

philly_tracts <- philly_tracts %>%
  filter(COUNTYFP == "101")

map_tracts <- left_join(philly_tracts, acs_data, by = "GEOID")

map_tracts <- map_tracts %>%
  st_set_crs(4326)
```

```{r}
#| echo: false
#| include: false
philadelphia_svi <- find_svi(year = 2022, state = "PA", geography = "tract")

# Filter for Philadelphia County (FIPS code for Philadelphia County is 42101)
philadelphia_svi <- subset(philadelphia_svi, grepl("^42101", GEOID)) %>%
  select(-c("year", "state"))
```

```{r}
#| echo: false
#| include: false
philadelphia_eji <- read_csv("data/EJI_2024_Pennsylvania_CSV/EJI_2024_Pennsylvania.csv")

philadelphia_eji <- philadelphia_eji %>%
  filter(COUNTYFP == "101") %>%
  select(c("GEOID", "RPL_EBM", "RPL_CBM", "RPL_HVM", "RPL_EJI_CBM")) %>%
  mutate(
    RPL_EBM = na_if(RPL_EBM, -999),
    RPL_CBM = na_if(RPL_CBM, -999),
    RPL_HVM = na_if(RPL_HVM, -999),
    RPL_EJI_CBM = na_if(RPL_EJI_CBM, -999)
  )

philadelphia_eji$GEOID <- as.character(philadelphia_eji$GEOID)

write.csv(philadelphia_eji, "philadelphia_eji.csv", row.names = FALSE)
```

```{r}
#| echo: false
#| include: false
map_tracts <- left_join(map_tracts, philadelphia_svi, by = "GEOID")

map_tracts <- left_join(map_tracts, philadelphia_eji, by = "GEOID")
```

```{r}
#| echo: false
#| include: false
PFAS_POI <- st_read("data/POI_PFAS.geojson")

MP_POI <- st_read("data/POI_MP.geojson")
```

**NOTE:** Hispanic, Native American, Pacific Islander, and Drop Out percentages are colored numerically and represent absolute values in percents on a continuous scale. This means **only extreme outliers will show darker colors**, this is because they didn't have enough observations to color by quantiles.

-   All other maps are colored by quantiles, which divides the data into groups with an equal number of census tracts, making it easy to compare between the high-value and low-value populations or areas. This is better for identifying clusters and comparing different areas.

- You'll be able to see the absolute value by hovering and clicking on the tract.

#### The color palette goes from low (purple) to high (yellow). All census data from 2024 5-year ACS, aggregated by census tracts.

::: {layout-ncol=2}
## Population Map
```{r}
#| echo: false

#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
pop_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11)

# Full map.
pop_map <- pop_map %>%
  
  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%

  # Median income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, prefix = "$", big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
  
  # White.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_white)(pct_white),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_white, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent White"
  ) %>%
  
  # Black.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_black)(pct_black),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_black, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Black"
  ) %>%
  
  # Hispanic.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorNumeric("viridis", pct_hispanic)(pct_hispanic),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_hispanic, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Hispanic"
  ) %>%

  # Asian.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_asian)(pct_asian),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_asian, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Asian"
  ) %>%
  
  # Native.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorNumeric("viridis", pct_native)(pct_native),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_native, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Native American"
  ) %>%
  
  # Pacific.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorNumeric("viridis", pct_pacific)(pct_pacific),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_pacific, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Hawaiian / Pacific Islander"
  ) %>%
  
  # Other.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_other)(pct_other),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_other, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Other Race"
  ) %>%
  
  # Two or more races.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_two_more)(pct_two_more),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_two_more, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Two or More Races"
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_white),
    values = map_tracts$pct_white,
    title = "% White",
    opacity = 0.75,
    group = "Percent White"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_black),
    values = map_tracts$pct_black,
    title = "% Black",
    opacity = 0.75,
    group = "Percent Black"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", map_tracts$pct_hispanic),
    values = map_tracts$pct_hispanic,
    title = "% Hispanic",
    opacity = 0.75,
    labFormat = labelFormat(suffix = "%"),
    group = "Percent Hispanic"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_asian),
    values = map_tracts$pct_asian,
    title = "% Asian",
    opacity = 0.75,
    group = "Percent Asian"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", map_tracts$pct_native),
    values = map_tracts$pct_native,
    title = "% Native<br>American",
    opacity = 0.75,
    labFormat = labelFormat(suffix = "%"),
    group = "Percent Native American"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", map_tracts$pct_pacific),
    values = map_tracts$pct_pacific,
    title = "% Hawaiian /<br>Pacific Islander",
    opacity = 0.75,
    labFormat = labelFormat(suffix = "%"),
    group = "Percent Hawaiian / Pacific Islander"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_other),
    values = map_tracts$pct_other,
    title = "% Other<br>Race",
    opacity = 0.75,
    group = "Percent Other Race"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_two_more),
    values = map_tracts$pct_two_more,
    title = "% Two or<br>More Races",
    opacity = 0.75,
    group = "Percent Two or More Races"
  ) %>%
  
  # Add layer controls.
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Percent Black", "Percent Hispanic", "Percent White", "Percent Asian", "Percent Native American", "Percent Hawaiian / Pacific Islander", "Percent Other Race", "Percent Two or More Races"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Median Household Income", "Percent Black", "Percent Hispanic", "Percent White", "Percent Asian", "Percent Native American", "Percent Hawaiian / Pacific Islander", "Percent Other Race", "Percent Two or More Races"))

pop_map
```

## Age and Sex Map
```{r}
#| echo: false

#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
age_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11)

# Full map.
age_map <- age_map %>%
  
  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%
  
  # Median household income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
  
  # Minors.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_minor)(pct_minor),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_minor, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Minors (< 18 yrs.)"
  ) %>%
  
  # Adults.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_adult)(pct_adult),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_adult, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Adult (18 - 64 yrs.)"
  ) %>%
  
  # Elderly.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_elderly)(pct_elderly),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_elderly, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Elderly (65+ yrs.)"
  ) %>%
  
  
  # Female.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", female)(female),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(female, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Female"
  ) %>%
  
  
  # Male.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", male)(male),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(male, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Male"
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    labFormat = labelFormat(big.mark = ","),
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_minor),
    values = map_tracts$pct_minor,
    title = "% Minors<br>(< 18 yrs.)",
    opacity = 0.75,
    group = "Percent Minors (< 18 yrs.)"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_adult),
    values = map_tracts$pct_adult,
    title = "% Adult<br>(18 - 64 yrs.)",
    opacity = 0.75,
    group = "Percent Adult (18 - 64 yrs.)"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_elderly),
    values = map_tracts$pct_elderly,
    title = "% Elderly<br>(65+ yrs.)",
    opacity = 0.75,
    group = "Percent Elderly (65+ yrs.)"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$female),
    values = map_tracts$female,
    title = "% Female",
    opacity = 0.75,
    group = "Percent Female"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$male),
    values = map_tracts$male,
    title = "% Male",
    opacity = 0.75,
    group = "Percent Male"
  ) %>%
  
  # Add layer controls.
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Percent Minors (< 18 yrs.)", "Percent Adult (18 - 64 yrs.)", "Percent Elderly (65+ yrs.)", "Percent Female", "Percent Male"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Population Density", "Median Household Income", "Percent Minors (< 18 yrs.)", "Percent Adult (18 - 64 yrs.)", "Percent Elderly (65+ yrs.)", "Percent Male"))

age_map
```
:::

::: {layout-ncol=2}
## Education Map

```{r}
#| echo: false

#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
education_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11) %>%

  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%
  
  # Median income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
    
  # Undergrad.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_undergrad_age)(pct_undergrad_age),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_undergrad_age, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Undergraduate Age (18 - 24 yrs.)"
  ) %>%
  
  # Drop out.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorNumeric("viridis", pct_drop_out)(pct_drop_out),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_drop_out, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Drop-Out (16 - 19 yrs.)"
  ) %>%
  
  # Bachelor's.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_bach)(pct_bach),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_bach, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Bachelor's or More"
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    labFormat = labelFormat(big.mark = ","),
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_undergrad_age),
    values = map_tracts$pct_undergrad_age,
    title = "% Undergraduate Age (18 - 24 yrs.)",
    opacity = 0.75,
    group = "Percent Undergraduate Age (18 - 24 yrs.)"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", map_tracts$pct_drop_out),
    values = map_tracts$pct_drop_out,
    title = "% Drop-Out (16 - 19 yrs.)",
    opacity = 0.75,
    labFormat = labelFormat(suffix = "%"),
    group = "Percent Drop-Out (16 - 19 yrs.)"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_bach),
    values = map_tracts$pct_bach,
    title = "% Bachelor's or More",
    opacity = 0.75,
    group = "Percent Bachelor's or More"
  ) %>%
  
  # Add layer controls.
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Percent Drop-Out (16 - 19 yrs.)", "Percent Undergraduate Age (18 - 24 yrs.)", "Percent Bachelor's or More"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Population Density", "Median Household Income", "Percent Drop-Out (16 - 19 yrs.)","Percent Bachelor's or More"))
  
education_map
```

## Housing Map

```{r}
#| echo: false

#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
housing_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11) %>%

  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%
  
  # Median income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
    
  # Homeowner.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_homeowner)(pct_homeowner),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_homeowner, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Homeowner"
  ) %>%
  
  # Renter.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_renter)(pct_renter),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_renter, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent Renter"
  ) %>%
  
  # No health insurance.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pct_no_health_insurance)(pct_no_health_insurance),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(pct_no_health_insurance, 2), nsmall = 2), "%", "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Percent No Health Insurance"
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    labFormat = labelFormat(big.mark = ","),
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_homeowner),
    values = map_tracts$pct_homeowner,
    title = "% Homeowner",
    opacity = 0.75,
    group = "Percent Homeowner"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_renter),
    values = map_tracts$pct_renter,
    title = "% Renter",
    opacity = 0.75,
    group = "Percent Renter"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pct_no_health_insurance),
    values = map_tracts$pct_no_health_insurance,
    title = "% No Health Insurance",
    opacity = 0.75,
    group = "Percent No Health Insurance"
  ) %>%
  
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Percent Homeowner", "Percent Renter", "Percent No Health Insurance"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Population Density", "Median Household Income", "Percent Homeowner", "Percent Renter"))
  
housing_map
```
:::

## [2022 Social Vulnerability Index (SVI)](https://www.atsdr.cdc.gov/place-health/php/svi/index.html) Map

![SVI Themes](data/SVI-Overall-Theme-Indicator-Image.png)

```{r}
#| echo: false
#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
svi_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11) %>%
  
  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%
  
  # Median income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
    
  # Socioeconomic SVI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_theme1)(RPL_theme1),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_theme1, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Socioeconomic Status SVI"
  ) %>%
  
  # Household SVI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_theme2)(RPL_theme2),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_theme2, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Household Characteristics SVI"
  ) %>%
  
  # Racial and ethnic minority SVI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_theme3)(RPL_theme3),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_theme3, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Racial & Ethnic Minority Status SVI"
  ) %>%
  
  # Housing type and transportation SVI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_theme4)(RPL_theme4),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_theme4, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Housing Type & Transportation SVI"
  ) %>%
  
  # Overall SVI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_themes)(RPL_themes),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_themes, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Overall SVI"
  ) %>%
  
  # MP POIs
  addCircleMarkers(
    data = MP_POI,
    radius = 3,
    color = "black",
    fillColor = "black",
    fillOpacity = 1,
    opacity = 1,
    label = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ) %>% lapply(htmltools::HTML),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", "padding" = "3px 8px"),
      textsize = "12px",
      direction = "auto"
    ),
    popup = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ),
    group = "MP Points of Interest",
    options = pathOptions(pane = "markerPane")
  ) %>%
  
  # PFAS POIs
  addCircleMarkers(
    data = PFAS_POI,
    radius = 3,
    color = "red",
    fillColor = "red",
    fillOpacity = 1,
    opacity = 1,
    label = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ) %>% lapply(htmltools::HTML),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", "padding" = "3px 8px"),
      textsize = "12px",
      direction = "auto"
    ),
    popup = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ),
    group = "PFAS Points of Interest",
    options = pathOptions(pane = "markerPane")
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    labFormat = labelFormat(big.mark = ","),
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_theme1),
    values = map_tracts$RPL_theme1,
    title = "Socioeconomic Status SVI",
    opacity = 0.75,
    group = "Socioeconomic Status SVI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_theme2),
    values = map_tracts$RPL_theme2,
    title = "Household Characteristics SVI",
    opacity = 0.75,
    group = "Household Characteristics SVI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_theme3),
    values = map_tracts$RPL_theme3,
    title = "Racial & Ethnic Minority Status SVI",
    opacity = 0.75,
    group = "Racial & Ethnic Minority Status SVI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_theme4),
    values = map_tracts$RPL_theme4,
    title = "Housing Type & Transportation SVI",
    opacity = 0.75,
    group = "Housing Type & Transportation SVI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_themes),
    values = map_tracts$RPL_themes,
    title = "Overall SVI",
    opacity = 0.75,
    group = "Overall SVI"
  ) %>%
  
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Socioeconomic Status SVI", "Household Characteristics SVI", "Racial & Ethnic Minority Status SVI", "Racial & Ethnic Minority Status SVI", "Housing Type & Transportation SVI", "Overall SVI", "PFAS Points of Interest", "MP Points of Interest"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Population Density", "Median Household Income", "Socioeconomic Status SVI", "Household Characteristics SVI", "Racial & Ethnic Minority Status SVI", "Racial & Ethnic Minority Status SVI", "Housing Type & Transportation SVI"))
  
svi_map
```

## [2024 Environmental Justice Index (EJI)](https://www.atsdr.cdc.gov/place-health/php/eji/index.html) Map

![EJI Themes](data/Variable_graphic_v3.png)

![EJI Indicators](data/Climate-Burden-2.png)

```{r}
#| echo: false
#| fig-height: 10
#| fig-width: 12

# Leaflet mapping.

# Base layer.
ej_map <- leaflet(map_tracts) %>%
  addTiles() %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11) %>%

  # Population density.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", pop_density)(pop_density),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Population Density"
  ) %>%
  
  # Median income.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", med_h_inc)(med_h_inc),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Population Density (sq. mi.): ", format(pop_density, big.mark = ",", digits = 2, nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Median Household Income"
  ) %>%
    
  # Environmental burden.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_EBM)(RPL_EBM),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_EBM, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Environmental Burden EJI"
  ) %>%
  
  # Climate burden.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_CBM)(RPL_CBM),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_CBM, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Climate Burden EJI"
  ) %>%
  
  # Health vulnerability.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorNumeric("viridis", RPL_HVM)(RPL_HVM),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_HVM, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Health Vulnerability EJI"
  ) %>%
  
  # Overall EJI.
  addPolygons(
    data = map_tracts,
    fillColor = ~colorQuantile("viridis", RPL_EJI_CBM)(RPL_EJI_CBM),
    weight = 1,
    opacity = 1,
    color = "white",
    dashArray = "3",
    fillOpacity = 0.5,
    highlightOptions = highlightOptions(
      weight = 2,
      color = "black",
      dashArray = "",
      fillOpacity = 0.5,
      bringToFront = TRUE
    ),
    popup = ~paste0(
      "Tract: ", NAME, "<br>",
      "Value: ", format(round(RPL_EJI_CBM, 2), nsmall = 2), "<br>",
      "Median Income: $", format(med_h_inc, big.mark = ",", nsmall = 0)
    ),
    group = "Overall EJI"
  ) %>%
  
  # MP POIs
  addCircleMarkers(
    data = MP_POI,
    radius = 3,
    color = "black",
    fillColor = "black",
    fillOpacity = 1,
    opacity = 1,
    label = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ) %>% lapply(htmltools::HTML),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", "padding" = "3px 8px"),
      textsize = "12px",
      direction = "auto"
    ),
    popup = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ),
    group = "MP Points of Interest",
    options = pathOptions(pane = "markerPane")
  ) %>%
  
  # PFAS POIs
  addCircleMarkers(
    data = PFAS_POI,
    radius = 3,
    color = "red",
    fillColor = "red",
    fillOpacity = 1,
    opacity = 1,
    label = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ) %>% lapply(htmltools::HTML),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", "padding" = "3px 8px"),
      textsize = "12px",
      direction = "auto"
    ),
    popup = ~paste0(
      "<strong>", Name, "</strong><br>",
      Description
    ),
    group = "PFAS Points of Interest",
    options = pathOptions(pane = "markerPane")
  ) %>%
  
  # Add legends for each layer.
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$pop_density),
    values = map_tracts$pop_density,
    title = "Population<br>Density",
    opacity = 0.75,
    group = "Population Density"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$med_h_inc),
    values = map_tracts$med_h_inc,
    title = "Median<br>Income (Quantile)",
    opacity = 0.75,
    labFormat = labelFormat(big.mark = ","),
    group = "Median Household Income"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_EBM),
    values = map_tracts$RPL_EBM,
    title = "Environmental Burden EJI",
    opacity = 0.75,
    group = "Environmental Burden EJI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_CBM),
    values = map_tracts$RPL_CBM,
    title = "Climate Burden EJI",
    opacity = 0.75,
    group = "Climate Burden EJI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", map_tracts$RPL_HVM,),
    values = map_tracts$RPL_HVM,
    title = "Health Vulnerability EJI",
    opacity = 0.75,
    group = "Health Vulnerability EJI"
  ) %>%
  
  addLegend(
    position = "bottomright",
    pal = colorQuantile("viridis", map_tracts$RPL_EJI_CBM),
    values = map_tracts$RPL_EJI_CBM,
    title = "Overall EJI",
    opacity = 0.75,
    group = "Overall EJI"
  ) %>%
  
  addLayersControl(
    overlayGroups = c("Population Density", "Median Household Income", "Environmental Burden EJI", "Climate Burden EJI", "Health Vulnerability EJI", "Overall EJI", "PFAS Points of Interest", "MP Points of Interest"),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
    
  hideGroup(c("Population Density", "Median Household Income", "Environmental Burden EJI", "Climate Burden EJI", "Health Vulnerability EJI"))
  
ej_map
```

```{r}
#| eval: false
#| include: false
# Leaflet mapping.

# Restrict to 9 land-use categories, no sub-categories.
land_use <- st_read("data/Land_Use/Land_Use.shp") %>%
  st_set_crs(3857) %>%
  st_transform(4326) %>%
  select(c_dig1) %>%
  mutate(
    c_dig1 = recode_factor(
      c_dig1,
      `1` = "Residential",
      `2` = "Commercial",
      `3` = "Industrial",
      `4` = "Civic / Institution",
      `5` = "Transportation",
      `6` = "Culture / Recreation",
      `7` = "Park / Open Space",
      `8` = "Water",
      `9` = "Vacant / Other"
    )
  )

# Custom land use colors to match Philadelphia's color code.
landuse_colors <- c(
  "Residential"        = "#f2c649",
  "Commercial"         = "#e57200",
  "Industrial"         = "#a67c52",
  "Civic / Institution"= "#7f8dd3",
  "Transportation"     = "#c0c0c0",
  "Culture / Recreation"= "#ba68c8",
  "Park / Open Space"  = "#55a868",
  "Water"              = "#4fa9e8",
  "Vacant / Other"     = "#d9d9d9"
)

# Base map layer.
land_use_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  setView(lng = -75.1638, lat = 39.9523, zoom = 11)

# Assign colors.
for (cat in names(landuse_colors)) {
  subset_data <- land_use[land_use$c_dig1 == cat, ]
  if (nrow(subset_data) == 0) next
  
  land_use_map <- land_use_map %>%
    addPolygons(
      data = subset_data,
      group = cat,
      fillColor = landuse_colors[cat],
      color = "black",
      weight = 0.3,
      fillOpacity = 0.8,
      label = ~paste("Land Use:", c_dig1),
      highlightOptions = highlightOptions(
        weight = 1,
        color = "white",
        fillOpacity = 0.9,
        bringToFront = TRUE
      )
    )
}

land_use_map %>%
  addLayersControl(
    overlayGroups = names(landuse_colors),
    options = layersControlOptions(collapsed = TRUE)
  ) %>%
  addLegend(
    "bottomright",
    colors = landuse_colors,
    labels = names(landuse_colors),
    title = "Land Use",
    opacity = 0.9
  )

land_use_map
```
